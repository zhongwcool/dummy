<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上传新版本 - APK版本管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
            background-color: #f8f9fa;
        }

        .header {
            margin-bottom: 2rem;
            border-bottom: 1px solid #e5e5e5;
            padding-bottom: 1rem;
        }

        .upload-form {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 2rem;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
        }


    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1 class="text-center">APK版本管理系统</h1>
    </div>

    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="upload-form">
                <h3 class="mb-4">上传新版本</h3>
                <form id="uploadForm">
                    <div class="mb-3">
                        <label for="apkFile" class="form-label">APK文件</label>
                        <input type="file" class="form-control" id="apkFile" name="apk" accept=".apk" required>
                        <div class="form-text">请选择要上传的APK文件</div>
                    </div>
                    <div class="mb-3">
                        <label for="updateDescription" class="form-label">更新说明</label>
                        <textarea class="form-control" id="updateDescription" name="updateDescription" rows="5"
                                  placeholder="请输入本次更新的详细说明..." required></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="forceUpdate" name="forceUpdate">
                        <label class="form-check-label" for="forceUpdate">强制更新</label>
                        <div class="form-text">勾选后用户必须更新到最新版本才能继续使用</div>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">上传新版本</button>
                        <a href="/" class="btn btn-outline-secondary">返回首页</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="loading" id="loading">
    <div class="spinner-border text-light loading-spinner" role="status">
        <span class="visually-hidden">上传中...</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 上传表单提交
        const uploadForm = document.getElementById('uploadForm');
        uploadForm.addEventListener('submit', function (e) {
            e.preventDefault();
            uploadAPK();
        });
    });

    // 上传APK
    function uploadAPK() {
        const formData = new FormData(document.getElementById('uploadForm'));
        const loading = document.getElementById('loading');

        // 手动处理复选框状态，因为未勾选的复选框不会包含在FormData中
        const forceUpdateCheckbox = document.getElementById('forceUpdate');
        if (forceUpdateCheckbox.checked) {
            formData.set('forceUpdate', 'true');
        } else {
            formData.set('forceUpdate', 'false');
        }

        loading.style.display = 'flex';

        fetch('/api/update/upload', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || '上传失败');
                    });
                }
                return response.json();
            })
            .then(data => {
                loading.style.display = 'none';
                const version = data.version;
                alert(`上传成功！\n版本名称: ${version.versionName}\n版本号: ${version.versionCode}\n包名: ${version.packageName}`);
                document.getElementById('uploadForm').reset();

                // 询问是否跳转到首页查看
                if (confirm('上传成功！是否跳转到首页查看最新版本？')) {
                    window.location.href = '/';
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                console.error('上传失败:', error);
                alert(error.message || '上传失败，请重试');
            });
    }
</script>
</body>
</html>
